<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dragomir's AI — Persistent Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #0d1117;
  color: #c9d1d9;
}
.scrollable-area::-webkit-scrollbar { width: 8px; }
.scrollable-area::-webkit-scrollbar-thumb {
  background: #30363d; border-radius: 4px;
}
.scrollable-area::-webkit-scrollbar-track { background: #161b22; }
@keyframes blink { 50% { opacity: 0; } }
.blinking-cursor {
  animation: blink 0.75s step-end infinite;
  display: inline-block; width: 8px; height: 1.2em;
  background: #3b82f6; margin-left: 2px; vertical-align: middle;
}
.ai-content pre {
  background: #161b22; border: 1px solid #30363d;
  border-radius: 8px; padding: 0.75rem; overflow-x: auto;
}
.ai-content code {
  background: #3b82f630; border-radius: 4px;
  padding: 0.15rem 0.3rem; color: #60a5fa;
  font-family: 'Consolas', monospace;
}
.ai-content h1, .ai-content h2, .ai-content h3 {
  font-weight: 700; color: #60a5fa; margin-bottom: .3rem;
}
.ai-content table {
  border-collapse: collapse; width: 100%;
}
.ai-content th, .ai-content td {
  border: 1px solid #4a5568; padding: 6px 10px;
}
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
<div class="w-full max-w-7xl bg-gray-900 rounded-xl shadow-2xl flex h-[95vh] overflow-hidden border border-gray-700/50">
<!-- Sidebar -->
<div class="flex flex-col w-64 bg-gray-950 border-r border-gray-700/50 p-4">
  <h2 class="text-xl font-bold text-blue-400 mb-4 border-b border-gray-700 pb-2">Conversations</h2>
  <button id="new-chat-button"
    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md mb-4 flex items-center justify-center transition">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5"
        x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg> New Chat
  </button>
  <div id="conversations-list" class="flex-grow overflow-y-auto scrollable-area space-y-2 text-sm text-gray-400">
    Loading chats...
  </div>
  <p id="user-id-display" class="text-xs text-gray-500 mt-4 pt-2 border-t border-gray-700 break-all">User ID: N/A</p>
</div>

<!-- Chat Area -->
<div class="flex-grow flex flex-col">
<header class="p-4 bg-gray-950 border-b border-blue-500/50 flex justify-between items-center">
  <h1 class="text-2xl font-bold text-blue-400 flex items-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-blue-500" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path
        d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" /></svg>
    <span id="chat-title">Dragomir's AI</span>
  </h1>
  <div id="status-indicator" class="text-sm px-3 py-1 rounded-full bg-gray-600 text-white font-medium">Initializing...</div>
</header>

<div id="chat-container" class="flex-grow overflow-y-auto p-6 space-y-6 bg-gray-800 scrollable-area">
  <div class="flex justify-start">
    <div class="ai-content bg-gray-700/50 p-4 rounded-xl border-l-4 border-blue-600 max-w-4xl">
      <p class="font-semibold text-blue-400">System Status</p>
      <p id="initial-system-message">Connecting to database and authenticating...</p>
    </div>
  </div>
</div>

<!-- Typing Indicator -->
<div id="typing-indicator" class="hidden p-3 text-gray-400 italic bg-gray-900 border-t border-gray-700 text-sm">
  Dragomir's AI is typing<span class="dot-1">.</span><span class="dot-2">.</span><span class="dot-3">.</span>
</div>

<!-- Input -->
<div class="p-4 bg-gray-900 border-t border-gray-700 flex flex-col space-y-2">
  <div class="flex space-x-3 items-end">
    <input type="text" id="prompt-input" placeholder="Send a command or query..."
      class="flex-grow p-3 rounded-xl bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
      disabled onkeypress="if(event.key==='Enter')sendMessage()">
    <button id="send-button" onclick="sendMessage()"
      class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg disabled:opacity-50"
      disabled>Send</button>
  </div>
</div>
</div>
</div>

<script>
let userId=null,currentChatId=null,chatHistory=[],conversations=[],isTyping=false;
const apiKey="YOUR_GEMINI_API_KEY";
const chatContainer=document.getElementById('chat-container');
const promptInput=document.getElementById('prompt-input');
const sendButton=document.getElementById('send-button');
const statusIndicator=document.getElementById('status-indicator');
const userIdDisplay=document.getElementById('user-id-display');
const conversationsList=document.getElementById('conversations-list');
const typingIndicator=document.getElementById('typing-indicator');

function updateStatus(txt,bg){statusIndicator.textContent=txt;statusIndicator.className=`text-sm px-3 py-1 rounded-full text-white ${bg}`;}
function renderMarkdown(t){return t.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\n/g,'<br>');}

function appendMessage(role,text,isTypingEffect=false){
  const isUser=role==='user';
  const div=document.createElement('div');
  div.className=`flex ${isUser?'justify-end':'justify-start'}`;
  const bubble=document.createElement('div');
  bubble.className=isUser?'bg-blue-600 text-white p-4 rounded-xl rounded-br-none max-w-lg shadow-md':'ai-content bg-gray-700/50 text-gray-200 p-4 rounded-xl rounded-tl-none max-w-4xl shadow-md border-l-4 border-blue-600';
  const p=document.createElement('p');p.innerHTML=isTypingEffect?'...':renderMarkdown(text);
  bubble.appendChild(p);div.appendChild(bubble);chatContainer.appendChild(div);
  chatContainer.scrollTop=chatContainer.scrollHeight;
  return {textElement:p,bubbleContent:bubble};
}

// Smooth markdown typing animation
async function typeMessage(element,text,delay=10){
  return new Promise(resolve=>{
    const html=renderMarkdown(text);
    const temp=document.createElement('div');temp.innerHTML=html;
    const chars=temp.innerHTML.split('');element.innerHTML='';
    const cursor=document.createElement('span');cursor.className='blinking-cursor';element.appendChild(cursor);
    let i=0;function typeNext(){
      if(i<chars.length){cursor.insertAdjacentText('beforebegin',chars[i++]);chatContainer.scrollTop=chatContainer.scrollHeight;setTimeout(typeNext,delay);}
      else{cursor.remove();resolve();}
    }typeNext();
  });
}

function loadAllConversations(){
  const d=localStorage.getItem('conversations');conversations=d?JSON.parse(d):[];
  conversations.sort((a,b)=>b.updated_at-a.updated_at);renderConversationsList();
}
function saveAllConversations(){localStorage.setItem('conversations',JSON.stringify(conversations));renderConversationsList();}
function loadChatHistory(id){return JSON.parse(localStorage.getItem('chat_'+id+'_messages')||'[]');}
function saveChatHistory(id,h){localStorage.setItem('chat_'+id+'_messages',JSON.stringify(h));}
async function saveMessage(role,text){if(!currentChatId)return;chatHistory.push({role,parts:[{text}]});saveChatHistory(currentChatId,chatHistory);
  const idx=conversations.findIndex(c=>c.id===currentChatId);if(idx!=-1){conversations[idx].updated_at=Date.now();}
  saveAllConversations();
}
function renderConversationsList(){
  conversationsList.innerHTML='';
  if(!conversations.length){conversationsList.innerHTML='<p class="text-gray-500">No chats yet</p>';return;}
  conversations.forEach(c=>{
    const b=document.createElement('button');
    b.className=`w-full text-left p-3 rounded-lg ${c.id===currentChatId?'bg-blue-600 text-white':'bg-gray-800 text-gray-300 hover:bg-gray-700'}`;
    b.textContent=c.title||'New Chat';b.onclick=()=>loadChat(c.id);conversationsList.appendChild(b);
  });
}
function loadChat(id){
  currentChatId=id;chatHistory=loadChatHistory(id);
  renderConversationsList();chatContainer.innerHTML='';
  appendMessage('model','Welcome back! Here’s your conversation history:');
  chatHistory.forEach(m=>appendMessage(m.role,m.parts[0].text));
  updateStatus('Chat Loaded','bg-green-600');
  promptInput.disabled=false;sendButton.disabled=false;
}
function startNewChat(){
  const id='chat-'+Date.now();const now=Date.now();
  conversations.unshift({id,title:'New Conversation',created_at:now,updated_at:now});
  saveAllConversations();loadChat(id);
}
async function initPersistence(){
  userId=localStorage.getItem('localUserId')||'local-'+Math.random().toString(36).substring(2,9);
  localStorage.setItem('localUserId',userId);
  userIdDisplay.textContent='User ID: '+userId;
  loadAllConversations();
  if(conversations.length)loadChat(conversations[0].id);else startNewChat();
  updateStatus('Ready (Idle)','bg-green-600');
}
window.onload=initPersistence;

async function sendMessage(){
  if(isTyping)return;
  const prompt=promptInput.value.trim();if(!prompt)return;
  appendMessage('user',prompt);await saveMessage('user',prompt);
  promptInput.value='';isTyping=true;sendButton.disabled=true;promptInput.disabled=true;
  typingIndicator.classList.remove('hidden');
  const {textElement,bubbleContent}=appendMessage('model','...',true);
  try{
    const res=await fakeAiResponse(prompt); // simulate AI
    typingIndicator.classList.add('hidden');
    await typeMessage(textElement,res,8);
    await saveMessage('model',res);
  }catch(e){
    bubbleContent.innerHTML=`<p class='text-red-400'>Error: ${e.message}</p>`;
  }finally{
    isTyping=false;sendButton.disabled=false;promptInput.disabled=false;promptInput.focus();
    updateStatus('Ready (Idle)','bg-green-600');
  }
}

// ---- SIMULATED AI (replace with Gemini call if needed) ----
function fakeAiResponse(q){
  return new Promise(res=>{
    setTimeout(()=>{
      res(`**Response:** You said “${q}”.<br><br>Here’s some markdown:\n\n- Example\n- ChatGPT-style typing\n\n\`Code Sample\`\n\nDone!`);
    },1000);
  });
}
</script>
</body>
</html>

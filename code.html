<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dragomirâ€™s IDE Ultimate v5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --accent:#3c5bfd;
      --bg1:#0e1014;
      --bg2:#14161b;
      --bg3:#1c1f25;
      --border:#1f222a;
      --text:#e5e7eb;
    }
    body {
      margin:0;
      background:var(--bg1);
      color:var(--text);
      font-family:'Inter',sans-serif;
      height:100vh;
      overflow:hidden;
    }
    .monaco-editor,.monaco-editor *{font-family:'JetBrains Mono',monospace!important;}
    #terminal::-webkit-scrollbar,#fileExplorer::-webkit-scrollbar{width:6px;}
    #terminal::-webkit-scrollbar-thumb{background:var(--accent);border-radius:9999px;}
    #fileExplorer::-webkit-scrollbar-thumb{background:#2d3243;border-radius:9999px;}
    @keyframes blinkCaret{0%,49%{opacity:1;}50%,100%{opacity:0;}}
    .terminal-caret{display:inline-block;width:1px;background:#60a5fa;animation:blinkCaret 1s step-start infinite;}
  </style>
</head>

<body class="flex flex-col h-screen">
  <!-- Top bar -->
  <header class="h-12 flex items-center justify-between px-4 border-b border-[var(--border)] bg-[var(--bg2)]">
    <div class="flex items-center gap-2">
      <span class="text-[var(--accent)] font-semibold text-sm">Dragomirâ€™s IDE</span>
      <span id="status" class="text-xs text-slate-400">Ready</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="runBtn" class="px-3 py-1 rounded bg-[var(--accent)] text-xs font-semibold">Run</button>
      <button id="saveBtn" class="px-3 py-1 rounded bg-[var(--accent)] text-xs font-semibold">Save</button>
      <button id="openSettings" class="px-3 py-1 rounded bg-[var(--accent)] text-xs font-semibold">Settings</button>
    </div>
  </header>

  <!-- Layout -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-56 border-r border-[var(--border)] bg-[var(--bg2)] flex flex-col">
      <div class="px-3 py-2 text-xs uppercase tracking-wide text-slate-400 border-b border-[var(--border)] flex items-center justify-between">
        <span>Explorer</span>
        <div class="flex items-center">
          <button id="newFileBtn" class="flex items-center gap-1 px-2 py-0.5 text-xs rounded hover:bg-[var(--bg3)] text-slate-200">
            <span class="text-[var(--accent)]">ðŸž§</span> New
          </button>
          <div class="h-4 w-px bg-[var(--border)] mx-2"></div>
          <button id="uploadFileBtn" class="flex items-center gap-1 px-2 py-0.5 text-xs rounded hover:bg-[var(--bg3)] text-slate-200">
            <span class="text-[var(--accent)]">â­³</span> Import
          </button>
          <input id="fileInput" type="file" accept=".py,.txt" class="hidden" />
        </div>
      </div>
      <div id="fileExplorer" class="flex-1 overflow-y-auto text-sm flex flex-col"></div>
    </aside>
    <!-- Editor + Terminal -->
    <div class="flex-1 flex flex-col">
      <!-- Tabs -->
      <div id="tabs" class="h-9 flex items-center gap-1 px-2 border-b border-[var(--border)] bg-[var(--bg2)]"></div>

      <!-- Editor -->
      <div id="editor" class="flex-1 min-h-0"></div>

      <!-- Terminal -->
      <div id="terminalContainer" class="h-44 border-t border-[var(--border)] bg-[var(--bg2)] flex flex-col">
        <div id="terminalHeader"
          class="h-7 flex items-center justify-between px-3 text-xs text-slate-400 border-b border-[var(--border)] cursor-row-resize select-none">
          <span>Terminal</span>
          <div class="flex gap-2">
            <button id="termNew" class="hover:text-white">New session</button>
            <button id="termClear" class="hover:text-white">Clear</button>
          </div>
        </div>
        <div id="terminal" class="flex-1 text-xs px-3 py-2 overflow-y-auto whitespace-pre-wrap"></div>
      </div>
    </div>
  </div>

  <!-- Status bar -->
  <footer id="statusBar"
    class="h-5 px-3 text-[10px] bg-[var(--bg2)] border-t border-[var(--border)] flex items-center text-slate-400">
    Ready
  </footer>

  <!-- New File Modal -->
  <div id="newFileModal"
    class="hidden fixed inset-0 z-40 items-center justify-center bg-[rgba(0,0,0,0.35)]">
    <div class="bg-[var(--bg2)] border border-[var(--border)] rounded-lg w-80 p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold">Create new file</h2>
        <button id="closeNewFile" class="text-slate-400 hover:text-white text-sm">âœ•</button>
      </div>
      <input id="newFileName"
        class="w-full mb-3 bg-[var(--bg1)] border border-[var(--border)] rounded px-2 py-1 text-xs"
        placeholder="my_script.py" />
      <div class="flex justify-end">
        <button id="createFile"
          class="px-3 py-1 bg-[var(--accent)] rounded text-xs font-semibold">Create</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal"
    class="hidden fixed inset-0 z-40 items-center justify-center bg-[rgba(0,0,0,0.35)]">
    <div class="bg-[var(--bg2)] border border-[var(--border)] rounded-lg w-80 p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold">Settings</h2>
        <button id="closeSettings" class="text-slate-400 hover:text-white text-sm">âœ•</button>
      </div>

      <label class="block text-xs mb-1">Backend URL</label>
      <input id="backendUrlInput"
        class="w-full mb-3 bg-[var(--bg1)] border border-[var(--border)] rounded px-2 py-1 text-xs" />

      <label class="block text-xs mb-1">Editor font size</label>
      <input id="fontSizeInput" type="number" min="10" max="24"
        class="w-20 mb-3 bg-[var(--bg1)] border border-[var(--border)] rounded px-2 py-1 text-xs" />

      <label class="flex items-center gap-2 text-xs mb-3">
        <input id="minimapToggle" type="checkbox" class="accent-[var(--accent)]">
        Show minimap
      </label>

      <!-- Libraries Tab -->
      <div id="libSection" class="border-t border-[var(--border)] mt-3 pt-3">
        <h3 class="text-xs font-semibold mb-2">Python Libraries</h3>
        <div id="libraryList" class="max-h-32 overflow-y-auto text-xs mb-2"></div>
        <div class="flex gap-2">
          <input id="newLibInput" placeholder="Enter library name"
            class="flex-1 bg-[var(--bg1)] border border-[var(--border)] rounded px-2 py-1 text-xs" />
          <button id="installLib"
            class="px-2 py-1 bg-[var(--accent)] rounded text-xs font-semibold">Install</button>
        </div>
      </div>

      <div class="flex justify-end mt-3">
        <button id="saveSettings"
          class="px-3 py-1 bg-[var(--accent)] rounded text-xs font-semibold">Save</button>
      </div>
    </div>
  </div>

  <!-- Consent -->
  <div id="consentBar"
    class="hidden fixed bottom-2 left-1/2 -translate-x-1/2 z-50 bg-[var(--bg3)] border border-[var(--border)] rounded-md px-4 py-3 text-xs flex items-center gap-4 shadow-lg">
    <span>This site uses local storage. By continuing, you agree to the
      <a href="https://dragomirz.xyz/tos" target="_blank" rel="noreferrer"
        class="text-[var(--accent)] underline">Terms of Service</a>.
    </span>
    <button id="acceptConsent"
      class="px-3 py-1 bg-[var(--accent)] rounded text-xs font-semibold">Accept</button>
  </div>

  <!-- Core JavaScript -->
  <script>
    const STORAGE_KEY = "dragomir_ide_v5";
    const CONSENT_KEY = "dragomir_consent_v1";
    let state = {
      files: { "main.py": "a=int(input('age: '))\\nprint(f'You are {a} years old!')" },
      open: ["main.py"],
      active: "main.py",
      settings: { backendUrl: "http://127.0.0.1:5000", fontSize: 15, minimap: true }
    };
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try { state = JSON.parse(saved); } catch { }
    }
        const explorer = document.getElementById("fileExplorer");
    const consentBar = document.getElementById("consentBar");
    if (!localStorage.getItem(CONSENT_KEY)) consentBar.classList.remove("hidden");
    document.getElementById("acceptConsent").onclick = () => {
      localStorage.setItem(CONSENT_KEY, "1");
      consentBar.classList.add("hidden");
    };
    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // ===== MONACO EDITOR =====
    let editor;
require.config({ paths: { vs: "https://unpkg.com/monaco-editor@0.44.0/min/vs" } });
require(["vs/editor/editor.main"], function () {
  monaco.editor.defineTheme("dragomir-dark", {
    base: "vs-dark",
    inherit: true,
    rules: [],
    colors: {
      "editor.background": "#0e1014",
      "editor.foreground": "#e5e7eb",
      "editorCursor.foreground": "#3c5bfd",
      "editorCursor.background": "#0e1014",
      "editorCursor.border": "#0e1014",
      "editorLineHighlightBackground": "#16181d",
      "editorLineNumber.foreground": "#4b5563",
      "editorLineNumber.activeForeground": "#93c5fd",
      "editor.selectionBackground": "#3c5bfd40",
      "editor.inactiveSelectionBackground": "#3c5bfd20"
    }
  });

  editor = monaco.editor.create(document.getElementById("editor"), {
    value: state.files[state.active],
    language: "python",
    theme: "dragomir-dark",
    fontFamily: "'JetBrains Mono', monospace",
    fontSize: state.settings.fontSize,
    fontLigatures: true,
    cursorStyle: "line-thin",
    cursorBlinking: "blink",
    letterSpacing: 0.3,
    minimap: { enabled: state.settings.minimap },
    automaticLayout: true
  });

  renderExplorer();
  renderTabs();
});


    // ===== TERMINAL =====
    const terminal = document.getElementById("terminal");
    const statusEl = document.getElementById("status");
    const statusBar = document.getElementById("statusBar");
    const tabs = document.getElementById("tabs");
    let activeInputHandler = null, currentSessionId = null;

    function termWrite(text = "", isErr = false) {
      const div = document.createElement("div");
      div.textContent = text;
      div.style.color = isErr ? "#f87171" : "#d1d5db";
      terminal.appendChild(div);
      terminal.scrollTop = terminal.scrollHeight;
    }
    function setStatus(msg, tone = "neutral") {
      statusEl.textContent = msg;
      statusBar.textContent = msg;
      statusBar.style.color =
        tone === "running" ? "#93c5fd" :
        tone === "error"   ? "#fca5a5" : "#9ca3af";
    }

    // ===== FILE EXPLORER + FOLDERS =====
    function renderExplorer() {
      explorer.innerHTML = "";
      const tree = {};
      Object.keys(state.files).forEach(path => {
        const parts = path.split("/");
        let node = tree;
        parts.forEach((p, i) => {
          if (!node[p]) node[p] = (i === parts.length - 1) ? null : {};
          node = node[p] || node;
        });
      });

      function draw(obj, parent, prefix = "") {
        Object.entries(obj).forEach(([key, val]) => {
          if (val === null) {
            const row = document.createElement("div");
            row.className =
              "flex items-center justify-between pl-6 pr-3 py-1.5 text-xs hover:bg-[var(--bg3)] cursor-pointer " +
              (prefix + key === state.active ? "bg-[var(--bg3)]" : "");
            row.textContent = key;
            row.onclick = () => openFile(prefix + key);
            parent.appendChild(row);
          } else {
            const folder = document.createElement("details");
            folder.open = true;
            const summary = document.createElement("summary");
            summary.textContent = key;
            summary.className =
              "cursor-pointer px-2 py-1 text-xs text-slate-300 hover:text-white";
            folder.appendChild(summary);
            draw(val, folder, prefix + key + "/");
            parent.appendChild(folder);
          }
        });
      }
      draw(tree, explorer);
      saveState();
    }

    // ===== TABS =====
    function renderTabs() {
      tabs.innerHTML = "";
      state.open.forEach(name => {
        const tab = document.createElement("div");
        tab.className =
          "flex items-center gap-2 px-3 h-9 text-xs border-r border-[var(--border)] cursor-pointer " +
          (name === state.active ? "bg-[var(--bg3)]" : "bg-[var(--bg2)]");
        const span = document.createElement("span");
        span.textContent = name;
        const close = document.createElement("button");
        close.textContent = "Ã—";
        close.className = "text-slate-400 hover:text-white";
        close.onclick = e => { e.stopPropagation(); deleteFile(name); };
        tab.onclick = () => openFile(name);
        tab.appendChild(span);
        if (name !== "main.py") tab.appendChild(close);
        tabs.appendChild(tab);
      });
    }

    function openFile(name) {
      if (editor && state.active) state.files[state.active] = editor.getValue();
      state.active = name;
      if (!state.open.includes(name)) state.open.push(name);
      editor.setValue(state.files[name] || "");
      renderTabs();
      renderExplorer();
      saveState();
    }

    function deleteFile(name) {
      if (name === "main.py") return;
      delete state.files[name];
      const idx = state.open.indexOf(name);
      if (idx !== -1) state.open.splice(idx, 1);
      if (state.active === name) {
        state.active = state.open[state.open.length - 1] || "main.py";
        editor.setValue(state.files[state.active] || "");
      }
      renderTabs();
      renderExplorer();
      saveState();
    }
        // ===== RUN CODE =====
    document.getElementById("runBtn").onclick = () => {
      state.files[state.active] = editor.getValue();
      saveState();
      currentSessionId = null;
      runOnServer();
    };

    async function runOnServer(userInput = null) {
      const backend = state.settings.backendUrl;
      const payload = userInput
        ? { session_id: currentSessionId, user_input: userInput }
        : { code: editor.getValue() };

      if (!userInput) termWrite("â”€â”€â”€â”€â”€â”€ New Session â”€â”€â”€â”€â”€â”€");
      setStatus("Runningâ€¦", "running");

      try {
        const res = await fetch(backend + "/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.session_id) currentSessionId = data.session_id;

        if (data.needs_input || (data.stdout && data.stdout.includes("__REQUEST_INPUT__MARKER__"))) {
          let promptText = data.prompt || "";
          if (data.stdout && data.stdout.includes("__REQUEST_INPUT__MARKER__")) {
            const [before, after] = data.stdout.split("__REQUEST_INPUT__MARKER__");
            if (before.trim()) termWrite(before.trim());
            promptText = after || promptText;
          } else if (data.stdout && data.stdout.trim()) {
            termWrite(data.stdout.trim());
          }
          termPromptInput(promptText, v => runOnServer(v));
          setStatus("Waiting for inputâ€¦", "running");
          return;
        }

        if (data.stdout && data.stdout.trim()) termWrite(data.stdout.trim());
        if (data.stderr && data.stderr.trim()) termWrite(data.stderr.trim(), true);
        setStatus("Ready âœ“");
      } catch (err) {
        termWrite("Network error: " + err.message, true);
        setStatus("Error", "error");
      }
    }

    // ===== INPUT HANDLER =====
    function termPromptInput(promptText, callback) {
      if (activeInputHandler) {
        window.removeEventListener("keydown", activeInputHandler);
        activeInputHandler = null;
      }
      if (promptText && promptText.trim() !== "") {
        const label = document.createElement("span");
        label.textContent = promptText;
        label.style.color = "#60a5fa";
        terminal.appendChild(label);
      }
      const inputSpan = document.createElement("span");
      inputSpan.style.color = "#60a5fa";
      let value = "";
      const caret = document.createElement("span");
      caret.textContent = "â”‚";
      caret.className = "terminal-caret";
      inputSpan.appendChild(caret);
      terminal.appendChild(inputSpan);
      terminal.scrollTop = terminal.scrollHeight;

      const handler = (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          window.removeEventListener("keydown", handler);
          activeInputHandler = null;
          caret.remove();
          inputSpan.textContent = value;
          terminal.appendChild(document.createElement("br"));
          callback(value.trim());
          return;
        }
        if (e.key === "Backspace") {
          e.preventDefault();
          value = value.slice(0, -1);
        } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
          value += e.key;
        }
        inputSpan.textContent = value;
        inputSpan.appendChild(caret);
        terminal.scrollTop = terminal.scrollHeight;
      };
      activeInputHandler = handler;
      window.addEventListener("keydown", handler);
    }

    // ===== LIBRARY MANAGER =====
    async function refreshLibraries() {
      const backend = state.settings.backendUrl;
      const list = document.getElementById("libraryList");
      list.textContent = "Loading...";
      try {
        const res = await fetch(backend + "/libraries");
        const libs = await res.json();
        if (!Array.isArray(libs)) throw new Error("Invalid response");
        list.innerHTML = "";
        libs.forEach(lib => {
          const div = document.createElement("div");
          div.textContent = `${lib.name} ${lib.version}`;
          div.className = "px-2 py-0.5 hover:bg-[var(--bg3)]";
          list.appendChild(div);
        });
      } catch (err) {
        list.textContent = "Error loading libraries.";
      }
    }

    document.getElementById("installLib").onclick = async () => {
      const name = document.getElementById("newLibInput").value.trim();
      if (!name) return;
      const backend = state.settings.backendUrl;
      const res = await fetch(backend + "/libraries", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      const result = await res.json();
      termWrite(result.message || result.error || JSON.stringify(result));
      refreshLibraries();
    };

    document.getElementById("openSettings").addEventListener("click", refreshLibraries);
        // ===== SAVE / NEW FILE / SETTINGS =====
    document.getElementById("saveBtn").onclick = () => {
      state.files[state.active] = editor.getValue();
      saveState();
      termWrite("Saved âœ“");
      setStatus("Saved âœ“");
    };

    const newFileModal = document.getElementById("newFileModal");
    const newFileName = document.getElementById("newFileName");
    document.getElementById("newFileBtn").onclick = () => {
      newFileName.value = "";
      newFileModal.classList.remove("hidden");
      newFileModal.classList.add("flex");
      newFileName.focus();
    };
    document.getElementById("closeNewFile").onclick = () => {
      newFileModal.classList.add("hidden");
    };
    document.getElementById("createFile").onclick = () => {
      const name = newFileName.value.trim();
      if (!name) return;
      if (!state.files[name]) state.files[name] = "# " + name;
      if (!state.open.includes(name)) state.open.push(name);
      openFile(name);
      newFileModal.classList.add("hidden");
    };

    const settingsModal = document.getElementById("settingsModal");
    document.getElementById("closeSettings").onclick = () => {
      settingsModal.classList.add("hidden");
    };
    document.getElementById("saveSettings").onclick = () => {
      state.settings.backendUrl =
        document.getElementById("backendUrlInput").value.trim() || "http://127.0.0.1:5000";
      state.settings.fontSize =
        parseInt(document.getElementById("fontSizeInput").value || "15", 10);
      state.settings.minimap =
        document.getElementById("minimapToggle").checked;
      saveState();
      if (editor) {
        editor.updateOptions({
          fontSize: state.settings.fontSize,
          minimap: { enabled: state.settings.minimap }
        });
      }
      settingsModal.classList.add("hidden");
      termWrite("Settings saved âœ“");
      setStatus("Settings saved âœ“");
    };

    document.getElementById("termClear").onclick = () => {
      terminal.textContent = "";
    };
    document.getElementById("termNew").onclick = () => {
      termWrite("â”€â”€â”€â”€â”€â”€ New Session â”€â”€â”€â”€â”€â”€");
    };

    // ===== TERMINAL RESIZE =====
    (() => {
      const header = document.getElementById("terminalHeader");
      const container = document.getElementById("terminalContainer");
      let active = false, startY = 0, startH = 0;
      header.addEventListener("mousedown", e => {
        active = true;
        startY = e.clientY;
        startH = container.offsetHeight;
        document.body.style.userSelect = "none";
      });
      window.addEventListener("mousemove", e => {
        if (!active) return;
        const dy = startY - e.clientY;
        const newH = Math.min(window.innerHeight * 0.8, Math.max(100, startH + dy));
        container.style.height = newH + "px";
      });
      window.addEventListener("mouseup", () => {
        active = false;
        document.body.style.userSelect = "";
      });
    })();

    // ===== INITIAL SETTINGS LOAD =====
    document.getElementById("openSettings").onclick = () => {
      document.getElementById("backendUrlInput").value = state.settings.backendUrl;
      document.getElementById("fontSizeInput").value = state.settings.fontSize;
      document.getElementById("minimapToggle").checked = !!state.settings.minimap;
      settingsModal.classList.remove("hidden");
      settingsModal.classList.add("flex");
      refreshLibraries();
    };
  </script>
</body>
</html>
